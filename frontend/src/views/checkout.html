<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh To√°n</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/checkout.css" />
    <link rel="stylesheet" href="../assets/css/api-styles.css" />
    <link rel="stylesheet" href="../assets/css/common-responsive.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <img src="../assets/images/logo.png" alt="PharmaT Logo" class="logo-img" onclick="window.location.href='home.html'">
      </div>
      <div class="page-title">
        <h1>Thanh to√°n h√≥a ƒë∆°n</h1>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="home.html" onclick="setActive(this)">üè† Trang ch·ªß</a>
        </li>
        <li>
          <a href="warehouse.html" onclick="setActive(this)">üì¶ Kho thu·ªëc</a>
        </li>
        <li>
          <a href="prescriptions.html" onclick="setActive(this)">üìù ƒê∆°n thu·ªëc</a>
        </li>
        <li>
          <a href="employees.html" onclick="setActive(this)">üë• Nh√¢n vi√™n</a>
        </li>
        <li><a href="checkout.html" onclick="setActive(this)">üí≥ Thanh to√°n</a></li>
        <li>
          <a href="reports.html" onclick="setActive(this)">üìà B√°o c√°o & Th·ªëng k√™</a>
        </li>
        <li>
          <a href="chatbox.html" onclick="setActive(this)">ü§ñ Chatbox c·∫£nh b√°o</a>
        </li>
      </ul>
      
      <!-- Logout Button -->
      <div class="sidebar-footer">
        <a href="login.html" class="logout-btn" onclick="logout()">
          <i class="fa-solid fa-sign-out-alt"></i>
          ƒêƒÉng xu·∫•t
        </a>
      </div>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <main>
      <div class="invoice-container">
        <div class="invoice-details">
          <p>M√£ ƒë∆°n: </p>
          <p>Kh√°ch h√†ng: </p>
          <p>Nh√¢n vi√™n: </p>
        </div>
        <div class="table-container">
          <table class="invoice-table">
            <thead>
              <tr>
                <th>T√™n thu·ªëc</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="payment-options">
          <label><input type="radio" name="payment" checked /> Ti·ªÅn m·∫∑t</label>
          <label><input type="radio" name="payment" /> Chuy·ªÉn kho·∫£n</label>
        </div>
        <div class="total-amount">T·ªîNG C·ªòNG: </div>
        <a href="#" class="btn">X√°c nh·∫≠n v√† t·∫°o h√≥a ƒë∆°n</a>
        <div class="footer-note">
          * H√≥a ƒë∆°n s·∫Ω ƒë∆∞·ª£c l∆∞u v√† g·ª≠i ƒë·∫øn ngay sau khi x√°c nh·∫≠n
        </div>
      </div>
    </main>

    <!-- QR Code Modal -->
    <div id="qrModal" class="qr-modal">
      <div class="qr-modal-content">
        <h3>üí≥ Thanh to√°n chuy·ªÉn kho·∫£n</h3>
        <div class="qr-code-container">
          <img src="../assets/images/qr.jpg" alt="QR Code" id="qrCodeImage">
        </div>
        <div class="qr-amount" id="qrAmount">0ƒë</div>
        <div class="qr-instructions">
          Qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng ƒë·ªÉ thanh to√°n<br>
          Ho·∫∑c chuy·ªÉn kho·∫£n ƒë·∫øn s·ªë t√†i kho·∫£n: <strong>1234567890</strong>
        </div>
        <div class="qr-modal-buttons">
          <button class="qr-btn qr-btn-primary" onclick="confirmQRPayment()">ƒê√£ thanh to√°n</button>
          <button class="qr-btn qr-btn-secondary" onclick="closeQRModal()">H·ªßy</button>
        </div>
      </div>
    </div>
  </body>
    <script src="../assets/js/sidebar.js"></script>
  <!-- Backend scripts removed for frontend-only version -->
  <script>
    let donThuocList = [];
    let selectedDonThuoc = null;

    // Load d·ªØ li·ªáu khi trang load
    document.addEventListener('DOMContentLoaded', async function() {
      // Hi·ªÉn th·ªã dropdown ngay t·ª´ ƒë·∫ßu
      displayDonThuocSelect();
      // Sau ƒë√≥ load d·ªØ li·ªáu
      await loadDonThuoc();
    });

    // Load danh s√°ch ƒë∆°n thu·ªëc ch∆∞a thanh to√°n
    async function loadDonThuoc() {
      try {
        UI.showLoading();
        const data = await API.getDonThuoc();
        donThuocList = data.records.filter(don => don.da_thanh_toan === 'Ch∆∞a thanh to√°n');
        updateDonThuocSelect();
      } catch (error) {
        UI.showMessage('L·ªói khi t·∫£i danh s√°ch ƒë∆°n thu·ªëc: ' + error.message, 'error');
        // V·∫´n c·∫≠p nh·∫≠t dropdown ngay c·∫£ khi c√≥ l·ªói
        updateDonThuocSelect();
      } finally {
        UI.hideLoading();
      }
    }

    // Hi·ªÉn th·ªã select ƒë∆°n thu·ªëc (lu√¥n xu·∫•t hi·ªán)
    function displayDonThuocSelect() {
      const container = document.querySelector('.invoice-details');
      const selectHtml = `
        <div class="don-thuoc-select">
          <label for="donThuocSelect">Ch·ªçn ƒë∆°n thu·ªëc:</label>
          <select id="donThuocSelect" onchange="loadDonThuocDetails()">
            <option value="">-- Ch·ªçn ƒë∆°n thu·ªëc --</option>
          </select>
        </div>
      `;
      
      container.innerHTML = selectHtml + container.innerHTML;
    }

    // C·∫≠p nh·∫≠t n·ªôi dung select ƒë∆°n thu·ªëc
    function updateDonThuocSelect() {
      const select = document.getElementById('donThuocSelect');
      if (!select) return;

      // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n
      select.innerHTML = '<option value="">-- Ch·ªçn ƒë∆°n thu·ªëc --</option>';
      
      // Th√™m c√°c ƒë∆°n thu·ªëc n·∫øu c√≥
      if (donThuocList.length > 0) {
        donThuocList.forEach(don => {
          const option = document.createElement('option');
          option.value = don.ma_don;
          option.textContent = `ƒê∆°n #${don.ma_don} - ${don.ten_kh}`;
          select.appendChild(option);
        });
      } else {
        // Th√™m th√¥ng b√°o khi kh√¥ng c√≥ ƒë∆°n thu·ªëc
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "-- Kh√¥ng c√≥ ƒë∆°n thu·ªëc ch∆∞a thanh to√°n --";
        option.disabled = true;
        select.appendChild(option);
      }
    }

    // Load chi ti·∫øt ƒë∆°n thu·ªëc
    async function loadDonThuocDetails() {
      const maDon = document.getElementById('donThuocSelect').value;
      if (!maDon) {
        clearInvoiceDetails();
        return;
      }

      selectedDonThuoc = donThuocList.find(don => don.ma_don == maDon);
      if (selectedDonThuoc) {
        try {
          UI.showLoading();
          // L·∫•y chi ti·∫øt thu·ªëc t·ª´ database
          const chiTietData = await API.getChiTietDonThuoc(maDon);
          selectedDonThuoc.chi_tiet = chiTietData.records;
          updateInvoiceDetails();
        } catch (error) {
          UI.showMessage('L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n thu·ªëc: ' + error.message, 'error');
        } finally {
          UI.hideLoading();
        }
      }
    }

    // C·∫≠p nh·∫≠t th√¥ng tin h√≥a ƒë∆°n
    function updateInvoiceDetails() {
      const detailsDiv = document.querySelector('.invoice-details');
      
      // Gi·ªØ l·∫°i dropdown, ch·ªâ c·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt
      const dropdownHtml = detailsDiv.querySelector('.don-thuoc-select').outerHTML;
      detailsDiv.innerHTML = dropdownHtml + `
        <p>M√£ ƒë∆°n: #${selectedDonThuoc.ma_don}</p>
        <p>Kh√°ch h√†ng: ${selectedDonThuoc.ten_kh}</p>
        <p>Nh√¢n vi√™n: ${selectedDonThuoc.ten_nv}</p>
        <p>Ng√†y t·∫°o: ${UI.formatDate(selectedDonThuoc.ngay_tao)}</p>
      `;

      // C·∫ßn g√°n l·∫°i event listener cho dropdown sau khi c·∫≠p nh·∫≠t HTML
      const newSelect = document.getElementById('donThuocSelect');
      if (newSelect) {
        newSelect.value = selectedDonThuoc.ma_don;
        newSelect.onchange = loadDonThuocDetails;
      }

      // Hi·ªÉn th·ªã danh s√°ch thu·ªëc
      displayInvoiceItems();
    }

    // Hi·ªÉn th·ªã danh s√°ch thu·ªëc trong h√≥a ƒë∆°n
    function displayInvoiceItems() {
      const tbody = document.querySelector('.invoice-table tbody');
      
      if (!selectedDonThuoc.chi_tiet || selectedDonThuoc.chi_tiet.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Kh√¥ng c√≥ thu·ªëc n√†o</td></tr>';
        document.querySelector('.total-amount').textContent = 'T·ªîNG C·ªòNG: 0ƒë';
        return;
      }

      let totalAmount = 0;
      tbody.innerHTML = '';

      selectedDonThuoc.chi_tiet.forEach(chiTiet => {
        const thanhTien = chiTiet.so_luong * chiTiet.gia_ban;
        totalAmount += thanhTien;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${chiTiet.ten_thuoc}</td>
          <td>${chiTiet.so_luong} ${chiTiet.don_vi}</td>
          <td>${UI.formatCurrency(chiTiet.gia_ban)}</td>
          <td>${UI.formatCurrency(thanhTien)}</td>
        `;
        tbody.appendChild(row);
      });

      // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
      document.querySelector('.total-amount').textContent = `T·ªîNG C·ªòNG: ${UI.formatCurrency(totalAmount)}`;
    }

    // X√≥a th√¥ng tin h√≥a ƒë∆°n
    function clearInvoiceDetails() {
      const detailsDiv = document.querySelector('.invoice-details');
      
      // Gi·ªØ l·∫°i dropdown, ch·ªâ x√≥a th√¥ng tin chi ti·∫øt
      const dropdownHtml = detailsDiv.querySelector('.don-thuoc-select').outerHTML;
      detailsDiv.innerHTML = dropdownHtml + `
        <p>M√£ ƒë∆°n: --</p>
        <p>Kh√°ch h√†ng: --</p>
        <p>Nh√¢n vi√™n: --</p>
      `;

      const tbody = document.querySelector('.invoice-table tbody');
      tbody.innerHTML = '';

      document.querySelector('.total-amount').textContent = 'T·ªîNG C·ªòNG: 0ƒë';
    }

    // X√°c nh·∫≠n thanh to√°n
    async function confirmPayment() {
      const selectedValue = document.getElementById('donThuocSelect').value;
      
      console.log('Debug - selectedValue:', selectedValue);
      console.log('Debug - selectedDonThuoc:', selectedDonThuoc);
      
      if (!selectedValue || selectedValue === "") {
        UI.showMessage('Vui l√≤ng ch·ªçn ƒë∆°n thu·ªëc c·∫ßn thanh to√°n', 'error');
        return;
      }

      if (!selectedDonThuoc) {
        UI.showMessage('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n thu·ªëc', 'error');
        return;
      }

      if (!selectedDonThuoc.chi_tiet || selectedDonThuoc.chi_tiet.length === 0) {
        UI.showMessage('ƒê∆°n thu·ªëc kh√¥ng c√≥ chi ti·∫øt thu·ªëc. Vui l√≤ng th·ª≠ ch·ªçn l·∫°i ƒë∆°n thu·ªëc.', 'error');
        return;
      }

      // L·∫•y ph∆∞∆°ng th·ª©c thanh to√°n
      const paymentMethodElement = document.querySelector('input[name="payment"]:checked');
      let paymentMethod = 'Ti·ªÅn m·∫∑t';
      if (paymentMethodElement) {
        const label = paymentMethodElement.closest('label');
        if (label) {
          paymentMethod = label.textContent.trim();
        }
      }

      // T√≠nh t·ªïng ti·ªÅn
      let totalAmount = 0;
      selectedDonThuoc.chi_tiet.forEach(chiTiet => {
        totalAmount += chiTiet.so_luong * chiTiet.gia_ban;
      });

      // N·∫øu l√† chuy·ªÉn kho·∫£n, hi·ªÉn th·ªã QR modal
      if (paymentMethod === 'Chuy·ªÉn kho·∫£n') {
        showQRModal(totalAmount);
        return;
      }

      // N·∫øu l√† ti·ªÅn m·∫∑t, x·ª≠ l√Ω thanh to√°n tr·ª±c ti·∫øp
      await processPayment(totalAmount, paymentMethod);
    }

    // Hi·ªÉn th·ªã QR modal
    function showQRModal(totalAmount) {
      const modal = document.getElementById('qrModal');
      const amountElement = document.getElementById('qrAmount');
      
      // C·∫≠p nh·∫≠t s·ªë ti·ªÅn
      amountElement.textContent = formatCurrency(totalAmount);
      
      // Hi·ªÉn th·ªã modal
      modal.style.display = 'block';
    }

    // ƒê√≥ng QR modal
    function closeQRModal() {
      const modal = document.getElementById('qrModal');
      modal.style.display = 'none';
    }

    // X√°c nh·∫≠n thanh to√°n QR
    async function confirmQRPayment() {
      const selectedValue = document.getElementById('donThuocSelect').value;
      
      if (!selectedValue || selectedValue === "") {
        UI.showMessage('Vui l√≤ng ch·ªçn ƒë∆°n thu·ªëc c·∫ßn thanh to√°n', 'error');
        return;
      }

      // T√≠nh t·ªïng ti·ªÅn
      let totalAmount = 0;
      selectedDonThuoc.chi_tiet.forEach(chiTiet => {
        totalAmount += chiTiet.so_luong * chiTiet.gia_ban;
      });

      // ƒê√≥ng modal v√† x·ª≠ l√Ω thanh to√°n
      closeQRModal();
      await processPayment(totalAmount, 'Chuy·ªÉn kho·∫£n');
    }

    // X·ª≠ l√Ω thanh to√°n
    async function processPayment(totalAmount, paymentMethod) {
      try {
        UI.showLoading();
        
        // T·∫°o h√≥a ƒë∆°n
        const hoaDonData = {
          don_thuoc_id: selectedDonThuoc.ma_don,
          ma_nv: selectedDonThuoc.ma_nv,
          tong_tien: totalAmount,
          phuong_thuc: paymentMethod
        };

        await API.createHoaDon(hoaDonData);

        UI.showMessage('Thanh to√°n th√†nh c√¥ng!', 'success');
        
        // Reload danh s√°ch ƒë∆°n thu·ªëc
        await loadDonThuoc();
        clearInvoiceDetails();
        
        // Reset dropdown v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
        const select = document.getElementById('donThuocSelect');
        if (select) {
          select.value = '';
        }
        
      } catch (error) {
        UI.showMessage('L·ªói khi thanh to√°n: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Format currency helper
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(amount);
    }

    // Th√™m event listener cho button x√°c nh·∫≠n
    document.addEventListener('DOMContentLoaded', function() {
      const confirmBtn = document.querySelector('.btn');
      if (confirmBtn) {
        confirmBtn.onclick = confirmPayment;
      }

      // ƒê√≥ng QR modal khi click b√™n ngo√†i
      const qrModal = document.getElementById('qrModal');
      if (qrModal) {
        qrModal.addEventListener('click', function(event) {
          if (event.target === qrModal) {
            closeQRModal();
          }
        });
      }
    });
  </script>
</html>
