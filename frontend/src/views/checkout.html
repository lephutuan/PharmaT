<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh To√°n</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/checkout.css" />
    <link rel="stylesheet" href="../assets/css/api-styles.css" />
    <link rel="stylesheet" href="../assets/css/common-responsive.css" />
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <a href="../../../index.html">
          <img
            src="../assets/images/logo.png"
            alt="PharmaT Logo"
            class="logo-img"
          />
        </a>
      </div>
      <div class="page-title">
        <h1>Thanh to√°n h√≥a ƒë∆°n</h1>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="../../../index.html" onclick="setActive(this)"
            >üè† Trang ch·ªß</a
          >
        </li>
        <li>
          <a href="warehouse.html" onclick="setActive(this)">üì¶ Kho thu·ªëc</a>
        </li>
        <li>
          <a href="prescriptions.html" onclick="setActive(this)"
            >üìù ƒê∆°n thu·ªëc</a
          >
        </li>
        <li>
          <a href="employees.html" onclick="setActive(this)">üë• Nh√¢n vi√™n</a>
        </li>
        <li>
          <a href="members.html" onclick="setActive(this)">üíé H·ªôi vi√™n</a>
        </li>
        <li>
          <a href="checkout.html" onclick="setActive(this)">üí≥ Thanh to√°n</a>
        </li>
        <li>
          <a href="reports.html" onclick="setActive(this)"
            >üìà B√°o c√°o & Th·ªëng k√™</a
          >
        </li>
        <li>
          <a href="chatbox.html" onclick="setActive(this)"
            >ü§ñ Chatbox c·∫£nh b√°o</a
          >
        </li>
      </ul>

      <!-- Logout Button -->
      <div class="sidebar-footer">
        <a href="login.html" class="logout-btn" onclick="logout()">
          <i class="fa-solid fa-sign-out-alt"></i>
          ƒêƒÉng xu·∫•t
        </a>
      </div>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <main>
      <div class="invoice-container">
        <div class="invoice-details">
          <p>M√£ ƒë∆°n:</p>
          <p>Kh√°ch h√†ng:</p>
          <p>Nh√¢n vi√™n:</p>
        </div>
        <div class="table-container">
          <table class="invoice-table">
            <thead>
              <tr>
                <th>T√™n thu·ªëc</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="payment-options">
          <label><input type="radio" name="payment" checked /> Ti·ªÅn m·∫∑t</label>
          <label><input type="radio" name="payment" /> Chuy·ªÉn kho·∫£n</label>
        </div>
        <div class="total-amount">T·ªîNG C·ªòNG:</div>
        <a href="#" class="btn">X√°c nh·∫≠n v√† t·∫°o h√≥a ƒë∆°n</a>
        <div class="footer-note">
          * H√≥a ƒë∆°n s·∫Ω ƒë∆∞·ª£c l∆∞u v√† g·ª≠i ƒë·∫øn ngay sau khi x√°c nh·∫≠n
        </div>
      </div>
    </main>

    <!-- QR Code Modal -->
    <div id="qrModal" class="qr-modal">
      <div class="qr-modal-content">
        <h3>üí≥ Thanh to√°n chuy·ªÉn kho·∫£n</h3>
        <div class="qr-code-container">
          <img src="../assets/images/qr.jpg" alt="QR Code" id="qrCodeImage" />
        </div>
        <div class="qr-amount" id="qrAmount">0ƒë</div>
        <div class="qr-instructions">
          Qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng ƒë·ªÉ thanh to√°n
        </div>
        <div class="qr-modal-buttons">
          <button class="qr-btn qr-btn-primary" onclick="confirmQRPayment()">
            ƒê√£ thanh to√°n
          </button>
          <button class="qr-btn qr-btn-secondary" onclick="closeQRModal()">
            H·ªßy
          </button>
        </div>
      </div>
    </div>
  </body>
  <script src="../assets/js/sidebar.js"></script>
  <script src="../config/supabase.js"></script>
  <script src="../config/api.js"></script>
  <script>
    let donThuocList = [];
    let selectedDonThuoc = null;

    // Load d·ªØ li·ªáu khi trang load
    document.addEventListener("DOMContentLoaded", async function () {
      // Hi·ªÉn th·ªã dropdown ngay t·ª´ ƒë·∫ßu
      displayDonThuocSelect();
      // Sau ƒë√≥ load d·ªØ li·ªáu
      await loadDonThuoc();
    });

    // Load danh s√°ch ƒë∆°n thu·ªëc ch∆∞a thanh to√°n
    async function loadDonThuoc() {
      try {
        UI.showLoading();
        const data = await API.getDonThuoc();
        // Filter ƒë∆°n thu·ªëc ƒë√£ l∆∞u (ch∆∞a thanh to√°n)
        donThuocList = data.records.filter(
          (don) => don.trang_thai === "ƒê√£ l∆∞u"
        );
        updateDonThuocSelect();
      } catch (error) {
        UI.showMessage(
          "L·ªói khi t·∫£i danh s√°ch ƒë∆°n thu·ªëc: " + error.message,
          "error"
        );
        // V·∫´n c·∫≠p nh·∫≠t dropdown ngay c·∫£ khi c√≥ l·ªói
        updateDonThuocSelect();
      } finally {
        UI.hideLoading();
      }
    }

    // Hi·ªÉn th·ªã select ƒë∆°n thu·ªëc (lu√¥n xu·∫•t hi·ªán)
    function displayDonThuocSelect() {
      const container = document.querySelector(".invoice-details");
      const selectHtml = `
        <div class="don-thuoc-select">
          <label for="donThuocSelect">Ch·ªçn ƒë∆°n thu·ªëc:</label>
          <select id="donThuocSelect" onchange="loadDonThuocDetails()">
            <option value="">-- Ch·ªçn ƒë∆°n thu·ªëc --</option>
          </select>
        </div>
      `;

      container.innerHTML = selectHtml + container.innerHTML;
    }

    // C·∫≠p nh·∫≠t n·ªôi dung select ƒë∆°n thu·ªëc
    function updateDonThuocSelect() {
      const select = document.getElementById("donThuocSelect");
      if (!select) return;

      // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n
      select.innerHTML = '<option value="">-- Ch·ªçn ƒë∆°n thu·ªëc --</option>';

      // Th√™m c√°c ƒë∆°n thu·ªëc n·∫øu c√≥
      if (donThuocList.length > 0) {
        donThuocList.forEach((don) => {
          const option = document.createElement("option");
          option.value = don.ma_don;
          // Hi·ªÉn th·ªã th√¥ng tin kh√°ch h√†ng t·ª´ relation
          const tenKH = don.khach_hang ? don.khach_hang.ten_kh : "N/A";
          option.textContent = `ƒê∆°n #${don.ma_don} - ${tenKH}`;
          select.appendChild(option);
        });
      } else {
        // Th√™m th√¥ng b√°o khi kh√¥ng c√≥ ƒë∆°n thu·ªëc
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "-- Kh√¥ng c√≥ ƒë∆°n thu·ªëc ch∆∞a thanh to√°n --";
        option.disabled = true;
        select.appendChild(option);
      }
    }

    // Load chi ti·∫øt ƒë∆°n thu·ªëc
    async function loadDonThuocDetails() {
      const maDon = document.getElementById("donThuocSelect").value;
      if (!maDon) {
        clearInvoiceDetails();
        return;
      }

      selectedDonThuoc = donThuocList.find((don) => don.ma_don == maDon);
      if (selectedDonThuoc) {
        try {
          UI.showLoading();
          // L·∫•y chi ti·∫øt thu·ªëc t·ª´ database
          const chiTietData = await API.getChiTietDonThuoc(maDon);
          selectedDonThuoc.chi_tiet = chiTietData.records;
          updateInvoiceDetails();
        } catch (error) {
          UI.showMessage(
            "L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n thu·ªëc: " + error.message,
            "error"
          );
        } finally {
          UI.hideLoading();
        }
      }
    }

    // C·∫≠p nh·∫≠t th√¥ng tin h√≥a ƒë∆°n
    function updateInvoiceDetails() {
      const detailsDiv = document.querySelector(".invoice-details");

      // L·∫•y th√¥ng tin t·ª´ relations
      const khachHang = selectedDonThuoc.khach_hang;
      const tenKH = khachHang ? khachHang.ten_kh : "Kh√°ch v√£ng lai";
      const tenNV = selectedDonThuoc.nhan_vien
        ? selectedDonThuoc.nhan_vien.ten_nv
        : "N/A";
      const ngayLap =
        selectedDonThuoc.ngay_lap || new Date().toISOString().split("T")[0];

      // Th√¥ng tin h·ªôi vi√™n
      let memberInfo = "";
      if (khachHang && khachHang.loai_kh === "H·ªôi vi√™n") {
        const cap = khachHang.cap_thanh_vien || "Bronze";
        const capIcon =
          cap === "VIP"
            ? "üëë"
            : cap === "Gold"
            ? "ü•á"
            : cap === "Silver"
            ? "ü•à"
            : "ü•â";
        const discount =
          cap === "VIP"
            ? "20%"
            : cap === "Gold"
            ? "15%"
            : cap === "Silver"
            ? "10%"
            : "0%";
        const discountColor = cap === "Bronze" ? "#6b7280" : "#10b981";
        memberInfo = `
          <p><strong>C·∫•p h·ªôi vi√™n:</strong> ${capIcon} ${cap} <span style="color: ${discountColor}; font-weight: bold;">(${
          cap === "Bronze" ? "Ch∆∞a ƒë∆∞·ª£c" : "Gi·∫£m"
        } ${discount})</span></p>
        `;
      }

      // Th√¥ng tin d·ªã ·ª©ng cho kh√°ch v√£ng lai
      let allergyInfo = "";
      if (selectedDonThuoc.di_ung_khach) {
        allergyInfo = `
          <p style="background: #fef3c7; padding: 8px; border-radius: 4px; margin-top: 5px;">
            <strong>‚ö†Ô∏è D·ªã ·ª©ng:</strong> ${selectedDonThuoc.di_ung_khach}
          </p>
        `;
      } else if (khachHang && khachHang.di_ung) {
        allergyInfo = `
          <p style="background: #fef3c7; padding: 8px; border-radius: 4px; margin-top: 5px;">
            <strong>‚ö†Ô∏è D·ªã ·ª©ng:</strong> ${khachHang.di_ung}
          </p>
        `;
      }

      // Gi·ªØ l·∫°i dropdown, ch·ªâ c·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt
      const dropdownHtml =
        detailsDiv.querySelector(".don-thuoc-select").outerHTML;
      detailsDiv.innerHTML =
        dropdownHtml +
        `
        <p>M√£ ƒë∆°n: #${selectedDonThuoc.ma_don}</p>
        <p>Kh√°ch h√†ng: ${tenKH}</p>
        ${memberInfo}
        <p>Nh√¢n vi√™n: ${tenNV}</p>
        <p>Ng√†y t·∫°o: ${formatDate(ngayLap)}</p>
        ${allergyInfo}
      `;

      // C·∫ßn g√°n l·∫°i event listener cho dropdown sau khi c·∫≠p nh·∫≠t HTML
      const newSelect = document.getElementById("donThuocSelect");
      if (newSelect) {
        newSelect.value = selectedDonThuoc.ma_don;
        newSelect.onchange = loadDonThuocDetails;
      }

      // Hi·ªÉn th·ªã danh s√°ch thu·ªëc
      displayInvoiceItems();
    }

    // Hi·ªÉn th·ªã danh s√°ch thu·ªëc trong h√≥a ƒë∆°n
    function displayInvoiceItems() {
      const tbody = document.querySelector(".invoice-table tbody");

      if (
        !selectedDonThuoc.chi_tiet ||
        selectedDonThuoc.chi_tiet.length === 0
      ) {
        tbody.innerHTML =
          '<tr><td colspan="4" style="text-align: center;">Kh√¥ng c√≥ thu·ªëc n√†o</td></tr>';
        document.querySelector(".total-amount").textContent = "T·ªîNG C·ªòNG: 0ƒë";
        return;
      }

      let totalAmount = 0;
      tbody.innerHTML = "";

      selectedDonThuoc.chi_tiet.forEach((chiTiet) => {
        // L·∫•y gi√° b√°n t·ª´ relation thuoc
        const giaBan = chiTiet.thuoc ? chiTiet.thuoc.gia_ban : 0;
        const tenThuoc = chiTiet.thuoc ? chiTiet.thuoc.ten_thuoc : "N/A";
        const donVi = chiTiet.thuoc ? chiTiet.thuoc.don_vi : "";
        const thanhTien = chiTiet.so_luong * giaBan;
        totalAmount += thanhTien;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${tenThuoc}</td>
          <td>${chiTiet.so_luong} ${donVi}</td>
          <td>${formatCurrency(giaBan)}</td>
          <td>${formatCurrency(thanhTien)}</td>
        `;
        tbody.appendChild(row);
      });

      // T√≠nh gi·∫£m gi√° cho h·ªôi vi√™n
      let discount = 0;
      let discountText = "";
      const khachHang = selectedDonThuoc.khach_hang;

      if (khachHang && khachHang.loai_kh === "H·ªôi vi√™n") {
        const cap = khachHang.cap_thanh_vien || "Bronze";
        const discountPercent =
          cap === "VIP"
            ? 0.2
            : cap === "Gold"
            ? 0.15
            : cap === "Silver"
            ? 0.1
            : 0;
        discount = totalAmount * discountPercent;
        if (discount > 0) {
          discountText = `
            <div style="text-align: right; color: #10b981; font-size: 1.1em; margin-top: 10px;">
              Gi·∫£m gi√° (${cap}): -${formatCurrency(discount)}
            </div>
          `;
        }
      }

      const finalAmount = totalAmount - discount;

      // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
      document.querySelector(".total-amount").innerHTML = `
        ${discountText}
        <div style="font-size: 1.3em; margin-top: 10px;">T·ªîNG C·ªòNG: ${formatCurrency(
          finalAmount
        )}</div>
      `;
    }

    // X√≥a th√¥ng tin h√≥a ƒë∆°n
    function clearInvoiceDetails() {
      const detailsDiv = document.querySelector(".invoice-details");

      // Gi·ªØ l·∫°i dropdown, ch·ªâ x√≥a th√¥ng tin chi ti·∫øt
      const dropdownHtml =
        detailsDiv.querySelector(".don-thuoc-select").outerHTML;
      detailsDiv.innerHTML =
        dropdownHtml +
        `
        <p>M√£ ƒë∆°n: --</p>
        <p>Kh√°ch h√†ng: --</p>
        <p>Nh√¢n vi√™n: --</p>
      `;

      const tbody = document.querySelector(".invoice-table tbody");
      tbody.innerHTML = "";

      document.querySelector(".total-amount").textContent = "T·ªîNG C·ªòNG: 0ƒë";
    }

    // X√°c nh·∫≠n thanh to√°n
    async function confirmPayment() {
      const selectedValue = document.getElementById("donThuocSelect").value;

      console.log("Debug - selectedValue:", selectedValue);
      console.log("Debug - selectedDonThuoc:", selectedDonThuoc);

      if (!selectedValue || selectedValue === "") {
        UI.showMessage("Vui l√≤ng ch·ªçn ƒë∆°n thu·ªëc c·∫ßn thanh to√°n", "error");
        return;
      }

      if (!selectedDonThuoc) {
        UI.showMessage("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n thu·ªëc", "error");
        return;
      }

      if (
        !selectedDonThuoc.chi_tiet ||
        selectedDonThuoc.chi_tiet.length === 0
      ) {
        UI.showMessage(
          "ƒê∆°n thu·ªëc kh√¥ng c√≥ chi ti·∫øt thu·ªëc. Vui l√≤ng th·ª≠ ch·ªçn l·∫°i ƒë∆°n thu·ªëc.",
          "error"
        );
        return;
      }

      // L·∫•y ph∆∞∆°ng th·ª©c thanh to√°n
      const paymentMethodElement = document.querySelector(
        'input[name="payment"]:checked'
      );
      let paymentMethod = "Ti·ªÅn m·∫∑t";
      if (paymentMethodElement) {
        const label = paymentMethodElement.closest("label");
        if (label) {
          paymentMethod = label.textContent.trim();
        }
      }

      // T√≠nh t·ªïng ti·ªÅn g·ªëc
      let totalAmount = 0;
      selectedDonThuoc.chi_tiet.forEach((chiTiet) => {
        const giaBan = chiTiet.thuoc ? chiTiet.thuoc.gia_ban : 0;
        totalAmount += chiTiet.so_luong * giaBan;
      });

      // T√≠nh gi·∫£m gi√° cho h·ªôi vi√™n
      let discount = 0;
      const khachHang = selectedDonThuoc.khach_hang;
      if (khachHang && khachHang.loai_kh === "H·ªôi vi√™n") {
        const cap = khachHang.cap_thanh_vien || "Bronze";
        const discountPercent =
          cap === "VIP"
            ? 0.2
            : cap === "Gold"
            ? 0.15
            : cap === "Silver"
            ? 0.1
            : 0;
        discount = totalAmount * discountPercent;
      }

      const finalAmount = totalAmount - discount;

      // N·∫øu l√† chuy·ªÉn kho·∫£n, hi·ªÉn th·ªã QR modal
      if (paymentMethod === "Chuy·ªÉn kho·∫£n") {
        showQRModal(finalAmount);
        return;
      }

      // N·∫øu l√† ti·ªÅn m·∫∑t, x·ª≠ l√Ω thanh to√°n tr·ª±c ti·∫øp
      await processPayment(finalAmount, paymentMethod);
    }

    // Hi·ªÉn th·ªã QR modal
    function showQRModal(totalAmount) {
      const modal = document.getElementById("qrModal");
      const amountElement = document.getElementById("qrAmount");

      // C·∫≠p nh·∫≠t s·ªë ti·ªÅn
      amountElement.textContent = formatCurrency(totalAmount);

      // Hi·ªÉn th·ªã modal
      modal.style.display = "block";
    }

    // ƒê√≥ng QR modal
    function closeQRModal() {
      const modal = document.getElementById("qrModal");
      modal.style.display = "none";
    }

    // X√°c nh·∫≠n thanh to√°n QR
    async function confirmQRPayment() {
      const selectedValue = document.getElementById("donThuocSelect").value;

      if (!selectedValue || selectedValue === "") {
        UI.showMessage("Vui l√≤ng ch·ªçn ƒë∆°n thu·ªëc c·∫ßn thanh to√°n", "error");
        return;
      }

      // T√≠nh t·ªïng ti·ªÅn g·ªëc
      let totalAmount = 0;
      selectedDonThuoc.chi_tiet.forEach((chiTiet) => {
        const giaBan = chiTiet.thuoc ? chiTiet.thuoc.gia_ban : 0;
        totalAmount += chiTiet.so_luong * giaBan;
      });

      // T√≠nh gi·∫£m gi√° cho h·ªôi vi√™n
      let discount = 0;
      const khachHang = selectedDonThuoc.khach_hang;
      if (khachHang && khachHang.loai_kh === "H·ªôi vi√™n") {
        const cap = khachHang.cap_thanh_vien || "Bronze";
        const discountPercent =
          cap === "VIP"
            ? 0.2
            : cap === "Gold"
            ? 0.15
            : cap === "Silver"
            ? 0.1
            : 0;
        discount = totalAmount * discountPercent;
      }

      const finalAmount = totalAmount - discount;

      // ƒê√≥ng modal v√† x·ª≠ l√Ω thanh to√°n
      closeQRModal();
      await processPayment(finalAmount, "Chuy·ªÉn kho·∫£n");
    }

    // X·ª≠ l√Ω thanh to√°n
    async function processPayment(totalAmount, paymentMethod) {
      try {
        UI.showLoading();

        // L·∫•y th√¥ng tin c·∫ßn thi·∫øt
        const maKH = selectedDonThuoc.khach_hang
          ? selectedDonThuoc.khach_hang.ma_kh
          : null;
        const maNV = selectedDonThuoc.nhan_vien
          ? selectedDonThuoc.nhan_vien.ma_nv
          : null;

        // T·∫°o d·ªØ li·ªáu h√≥a ƒë∆°n
        const hoaDonData = {
          ma_kh: maKH,
          ma_nv: maNV,
          ma_don: selectedDonThuoc.ma_don,
          tong_tien: totalAmount,
          phuong_thuc_thanh_toan: paymentMethod,
          trang_thai: "ƒê√£ thanh to√°n",
          ghi_chu: "",
        };

        // T·∫°o chi ti·∫øt h√≥a ƒë∆°n
        const chiTietList = selectedDonThuoc.chi_tiet.map((chiTiet) => ({
          ma_thuoc: chiTiet.thuoc ? chiTiet.thuoc.ma_thuoc : chiTiet.ma_thuoc,
          so_luong: chiTiet.so_luong,
          don_gia: chiTiet.thuoc ? chiTiet.thuoc.gia_ban : 0,
        }));

        await API.createHoaDon(hoaDonData, chiTietList);

        UI.showMessage("Thanh to√°n th√†nh c√¥ng!", "success");

        // Reload danh s√°ch ƒë∆°n thu·ªëc
        await loadDonThuoc();
        clearInvoiceDetails();

        // Reset dropdown v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
        const select = document.getElementById("donThuocSelect");
        if (select) {
          select.value = "";
        }
      } catch (error) {
        console.error("L·ªói thanh to√°n:", error);
        UI.showMessage("L·ªói khi thanh to√°n: " + error.message, "error");
      } finally {
        UI.hideLoading();
      }
    }

    // Format currency helper
    function formatCurrency(amount) {
      return new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
      }).format(amount);
    }

    // Format date helper
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString("vi-VN");
    }

    // Th√™m event listener cho button x√°c nh·∫≠n
    document.addEventListener("DOMContentLoaded", function () {
      const confirmBtn = document.querySelector(".btn");
      if (confirmBtn) {
        confirmBtn.onclick = confirmPayment;
      }

      // ƒê√≥ng QR modal khi click b√™n ngo√†i
      const qrModal = document.getElementById("qrModal");
      if (qrModal) {
        qrModal.addEventListener("click", function (event) {
          if (event.target === qrModal) {
            closeQRModal();
          }
        });
      }
    });
  </script>
</html>
