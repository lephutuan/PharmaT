<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quáº£n LÃ½ Tiá»‡m Thuá»‘c Tá»± Äá»™ng - NhÃ¢n ViÃªn</title>
    <link rel="stylesheet" href="../assets/css/employees.css" />
    <link rel="stylesheet" href="../assets/css/api-styles.css" />
    <link rel="stylesheet" href="../assets/css/common-responsive.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <img src="../assets/images/logo.png" alt="PharmaT Logo" class="logo-img" onclick="window.location.href='../../index.html'">
      </div>
      <div class="page-title">
        <h1>Quáº£n lÃ½ nhÃ¢n viÃªn</h1>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="../../../index.html" onclick="setActive(this)">ğŸ  Trang chá»§</a>
        </li>
        <li>
          <a href="warehouse.html" onclick="setActive(this)">ğŸ“¦ Kho thuá»‘c</a>
        </li>
        <li>
          <a href="prescriptions.html" onclick="setActive(this)">ğŸ“ ÄÆ¡n thuá»‘c</a>
        </li>
        <li>
          <a href="employees.html" onclick="setActive(this)">ğŸ‘¥ NhÃ¢n viÃªn</a>
        </li>
        <li><a href="members.html" onclick="setActive(this)">ğŸ’ Há»™i viÃªn</a></li>
        <li><a href="checkout.html" onclick="setActive(this)">ğŸ’³ Thanh toÃ¡n</a></li>
        <li>
          <a href="reports.html" onclick="setActive(this)">ğŸ“ˆ BÃ¡o cÃ¡o & Thá»‘ng kÃª</a>
        </li>
        <li>
          <a href="chatbox.html" onclick="setActive(this)">ğŸ¤– Chatbox cáº£nh bÃ¡o</a>
        </li>
      </ul>
      
      <!-- Logout Button -->
      <div class="sidebar-footer">
        <a href="login.html" class="logout-btn" onclick="logout()">
          <i class="fa-solid fa-sign-out-alt"></i>
          ÄÄƒng xuáº¥t
        </a>
      </div>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <main>

    <!-- Form thÃªm/sá»­a -->
      <section class="form-section">
        <h2>ThÃªm nhÃ¢n viÃªn</h2>
        <div class="employee-form">
          <input type="text" id="ten_nv" placeholder="Há» tÃªn nhÃ¢n viÃªn" />
          <select id="chuc_vu">
            <option value="">-- Chá»©c vá»¥ --</option>
            <option value="Quáº£n lÃ½">Quáº£n lÃ½</option>
            <option value="BÃ¡n hÃ ng">BÃ¡n hÃ ng</option>
          </select>
          <input type="text" id="sdt" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i" />
          <input type="text" id="dia_chi" placeholder="Äá»‹a chá»‰" />
          <input type="password" id="mat_khau" placeholder="Máº­t kháº©u" />
          <select id="trang_thai">
            <option value="">-- Tráº¡ng thÃ¡i --</option>
            <option value="Äang lÃ m viá»‡c">Äang lÃ m viá»‡c</option>
            <option value="ÄÃ£ nghá»‰ viá»‡c">ÄÃ£ nghá»‰ viá»‡c</option>
          </select>
          <button class="btn btn-primary" onclick="saveEmployee()">ğŸ’¾ LÆ°u</button>
          <button class="btn btn-secondary" onclick="clearForm()">â†©ï¸ XÃ³a tráº¯ng</button>
          <button class="btn btn-cancel" onclick="cancelEdit()" id="cancelBtn" style="display: none;">âŒ Há»§y chá»‰nh sá»­a</button>
        </div>
      </section>

      <!-- Danh sÃ¡ch -->
      <section class="form-section">
        <h2>Danh sÃ¡ch nhÃ¢n viÃªn</h2>
        <table id="nhanvien-table" class="employee-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>Há» tÃªn</th>
              <th>Chá»©c vá»¥</th>
              <th>SÄT</th>
              <th>Äá»‹a chá»‰</th>
              <th>Máº­t kháº©u</th>
              <th>Tráº¡ng thÃ¡i</th>
              <th>HÃ nh Ä‘á»™ng</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c load tá»« API -->
          </tbody>
        </table>
      </section>
    </main>
  </body>
    <script src="../assets/js/sidebar.js"></script>
    <script src="../config/supabase.js"></script>
    <script src="../config/api.js"></script>
  <script>
    let employees = [];
    let editingEmployeeId = null;

    // Load dá»¯ liá»‡u khi trang load
    document.addEventListener('DOMContentLoaded', async function() {
      await loadEmployees();
    });

    // Load danh sÃ¡ch nhÃ¢n viÃªn
    async function loadEmployees() {
      try {
        UI.showLoading();
        const data = await API.getNhanVien();
        employees = data.records;
        displayEmployees();
      } catch (error) {
        UI.showMessage('Lá»—i khi táº£i danh sÃ¡ch nhÃ¢n viÃªn: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Hiá»ƒn thá»‹ danh sÃ¡ch nhÃ¢n viÃªn
    function displayEmployees() {
      const tbody = document.querySelector('#nhanvien-table tbody');
      tbody.innerHTML = '';

      employees.forEach((employee, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${employee.ten_nv}</td>
          <td>${employee.chuc_vu}</td>
          <td>${employee.sdt}</td>
          <td>${employee.dia_chi}</td>
          <td>${employee.mat_khau ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'ChÆ°a cÃ³'}</td>
          <td>${employee.trang_thai}</td>
          <td>
            <button class="btn btn-small btn-edit" onclick="editEmployee(${employee.ma_nv})">âœï¸</button>
            <button class="btn btn-small btn-delete" onclick="deleteEmployee(${employee.ma_nv})">ğŸ—‘ï¸</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // LÆ°u nhÃ¢n viÃªn
    async function saveEmployee() {
      const ten_nv = document.getElementById('ten_nv').value;
      const chuc_vu = document.getElementById('chuc_vu').value;
      const sdt = document.getElementById('sdt').value;
      const dia_chi = document.getElementById('dia_chi').value;
      const mat_khau = document.getElementById('mat_khau').value;
      const trang_thai = document.getElementById('trang_thai').value;

      if (!ten_nv || !chuc_vu || !sdt || !dia_chi || !mat_khau || !trang_thai) {
        UI.showMessage('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin', 'error');
        return;
      }

      const employeeData = {
        ten_nv: ten_nv,
        chuc_vu: chuc_vu,
        sdt: sdt,
        dia_chi: dia_chi,
        mat_khau: mat_khau,
        trang_thai: trang_thai
      };

      try {
        UI.showLoading();
        
        if (editingEmployeeId) {
          // Cáº­p nháº­t nhÃ¢n viÃªn
          employeeData.ma_nv = editingEmployeeId;
          await API.updateNhanVien(editingEmployeeId, employeeData);
          UI.showMessage('Cáº­p nháº­t nhÃ¢n viÃªn thÃ nh cÃ´ng!', 'success');
        } else {
          // ThÃªm nhÃ¢n viÃªn má»›i
          await API.createNhanVien(employeeData);
          UI.showMessage('ThÃªm nhÃ¢n viÃªn thÃ nh cÃ´ng!', 'success');
        }

        await loadEmployees();
        clearForm();
        
      } catch (error) {
        UI.showMessage('Lá»—i: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Sá»­a nhÃ¢n viÃªn
    function editEmployee(ma_nv) {
      const employee = employees.find(emp => emp.ma_nv == ma_nv);
      if (employee) {
        editingEmployeeId = ma_nv;
        document.getElementById('ten_nv').value = employee.ten_nv;
        document.getElementById('chuc_vu').value = employee.chuc_vu;
        document.getElementById('sdt').value = employee.sdt;
        document.getElementById('dia_chi').value = employee.dia_chi;
        document.getElementById('mat_khau').value = employee.mat_khau || '';
        document.getElementById('trang_thai').value = employee.trang_thai;
        
        // Äá»•i text button vÃ  hiá»ƒn thá»‹ nÃºt há»§y
        document.querySelector('.btn-primary').textContent = 'ğŸ’¾ Cáº­p nháº­t';
        document.getElementById('cancelBtn').style.display = 'inline-block';
      }
    }

    // XÃ³a nhÃ¢n viÃªn
    async function deleteEmployee(ma_nv) {
      if (!UI.confirmDelete('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a nhÃ¢n viÃªn nÃ y?')) {
        return;
      }

      try {
        UI.showLoading();
        await API.deleteNhanVien(ma_nv);
        UI.showMessage('XÃ³a nhÃ¢n viÃªn thÃ nh cÃ´ng!', 'success');
        await loadEmployees();
      } catch (error) {
        UI.showMessage('Lá»—i khi xÃ³a nhÃ¢n viÃªn: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Há»§y chá»‰nh sá»­a
    function cancelEdit() {
      clearForm();
    }

    // XÃ³a tráº¯ng form
    function clearForm() {
      editingEmployeeId = null;
      document.getElementById('ten_nv').value = '';
      document.getElementById('chuc_vu').value = '';
      document.getElementById('sdt').value = '';
      document.getElementById('dia_chi').value = '';
      document.getElementById('mat_khau').value = '';
      document.getElementById('trang_thai').value = '';
      document.querySelector('.btn-primary').textContent = 'ğŸ’¾ LÆ°u';
      document.getElementById('cancelBtn').style.display = 'none';
    }
  </script>
</html>
