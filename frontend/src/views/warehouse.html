<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Ti·ªám Thu·ªëc T·ª± ƒê·ªông - Kho H√†ng</title>
    <link rel="stylesheet" href="../assets/css/warehouse.css?v=1.1" />
    <link rel="stylesheet" href="../assets/css/api-styles.css" />
    <link rel="stylesheet" href="../assets/css/common-responsive.css" />
    <!-- Awesomplete CSS & JS CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <a href="../../../index.html">
          <img src="../assets/images/logo.png" alt="PharmaT Logo" class="logo-img">
        </a>
      </div>
      <div class="page-title">
        <h1>Kho thu·ªëc</h1>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="../../../index.html" onclick="setActive(this)">üè† Trang ch·ªß</a>
        </li>
        <li>
          <a href="warehouse.html" onclick="setActive(this)">üì¶ Kho thu·ªëc</a>
        </li>
        <li>
          <a href="prescriptions.html" onclick="setActive(this)">üìù ƒê∆°n thu·ªëc</a>
        </li>
        <li>
          <a href="employees.html" onclick="setActive(this)">üë• Nh√¢n vi√™n</a>
        </li>
        <li><a href="members.html" onclick="setActive(this)">üíé H·ªôi vi√™n</a></li>
        <li><a href="checkout.html" onclick="setActive(this)">üí≥ Thanh to√°n</a></li>
        <li>
          <a href="reports.html" onclick="setActive(this)">üìà B√°o c√°o & Th·ªëng k√™</a>
        </li>
        <li>
          <a href="chatbox.html" onclick="setActive(this)">ü§ñ Chatbox c·∫£nh b√°o</a>
        </li>
      </ul>
      
      <!-- Logout Button -->
      <div class="sidebar-footer">
        <a href="login.html" class="logout-btn" onclick="logout()">
          <i class="fa-solid fa-sign-out-alt"></i>
          ƒêƒÉng xu·∫•t
        </a>
      </div>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
  <main>
    <div class="warehouse-actions">
      <button class="add-button">+ Th√™m m·ªõi</button>
      <div class="search-bar">
        <input type="text" id="warehouseSearchInput" placeholder="Search..." />
        <button id="warehouseSearchBtn"><i class="fa fa-search"></i></button>
      </div>
    </div>

    <div class="table-container">
      <table class="medicine-table">
        <thead>
          <tr>
            <th>·∫¢nh </th>
            <th>M√£ thu·ªëc <span class="sort-btn" onclick="sortTable(0)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>T√™n thu·ªëc <span class="sort-btn" onclick="sortTable(1)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>ƒê∆°n v·ªã <span class="sort-btn" onclick="sortTable(2)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>Gi√° nh·∫≠p <span class="sort-btn" onclick="sortTable(3)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>Gi√° b√°n <span class="sort-btn" onclick="sortTable(4)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>Ng√†y th√™m <span class="sort-btn" onclick="sortTable(5)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>S·ªë l∆∞·ª£ng <span class="sort-btn" onclick="sortTable(6)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>Nh√≥m thu·ªëc <span class="sort-btn" onclick="sortTable(7)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>H·∫°n s·ª≠ d·ª•ng <span class="sort-btn" onclick="sortTable(8)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
            <th>Tr·∫°ng th√°i <span class="sort-btn" onclick="sortTable(9)" title="S·∫Øp x·∫øp"><i class="fas fa-sort"></i></span></th>
          </tr>
        </thead>
        <tbody id="warehouseTableBody">
          <!-- D·ªØ li·ªáu thu·ªëc s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
        </tbody>
      </table>
    </div>
    <div class="pagination" id="warehousePagination"></div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu" style="display: none;">
      <div class="context-menu-item" onclick="editSelectedMedicine()">
        <i class="fas fa-edit"></i> S·ª≠a
      </div>
      <div class="context-menu-item" onclick="deleteSelectedMedicine()">
        <i class="fas fa-trash"></i> X√≥a
      </div>
    </div>

    <!-- Modal th√™m thu·ªëc m·ªõi -->
    <div id="addMedicineModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Th√™m thu·ªëc m·ªõi</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="addMedicineForm">
            <div class="form-row">
              <div class="form-group">
                <label for="medicineImage">·∫¢nh:</label>
                <input type="file" id="medicineImage" accept="image/*" />
              </div>
              <div class="form-group">
                <label for="medicineCode">M√£ thu·ªëc:</label>
                <input type="text" id="medicineCode" placeholder="Nh·∫≠p m√£ thu·ªëc" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="medicineName">T√™n thu·ªëc:</label>
                <input type="text" id="medicineName" placeholder="Nh·∫≠p t√™n thu·ªëc" />
              </div>
              <div class="form-group">
                <label for="medicineUnit">ƒê∆°n v·ªã:</label>
                <input type="text" id="medicineUnit" placeholder="Nh·∫≠p ƒë∆°n v·ªã" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="importPrice">Gi√° nh·∫≠p:</label>
                <input type="number" id="importPrice" placeholder="Nh·∫≠p gi√° nh·∫≠p" />
              </div>
              <div class="form-group">
                <label for="salePrice">Gi√° b√°n:</label>
                <input type="number" id="salePrice" placeholder="Nh·∫≠p gi√° b√°n" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="addDate">Ng√†y th√™m:</label>
                <input type="date" id="addDate" />
              </div>
              <div class="form-group">
                <label for="quantity">S·ªë l∆∞·ª£ng:</label>
                <input type="number" id="quantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng" min="0" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="minQuantity">S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu:</label>
                <input type="number" id="minQuantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng t·ªëi thi·ªÉu" min="0" />
              </div>
              <div class="form-group">
                <label for="expiryDate">H·∫°n s·ª≠ d·ª•ng:</label>
                <input type="date" id="expiryDate" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="medicineGroup">Nh√≥m thu·ªëc:</label>
                <select id="medicineGroup">
                  <option value="Thu·ªëc kh√¥ng k√™ ƒë∆°n">Thu·ªëc kh√¥ng k√™ ƒë∆°n</option>
                  <option value="Thu·ªëc k√™ ƒë∆°n">Thu·ªëc k√™ ƒë∆°n</option>
                  <option value="Th·ª±c ph·∫©m ch·ª©c nƒÉng">Th·ª±c ph·∫©m ch·ª©c nƒÉng</option>
                  <option value="D·ª•ng c·ª• y t·∫ø">D·ª•ng c·ª• y t·∫ø</option>
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-primary" onclick="saveMedicine()">L∆∞u</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal ch·ªânh s·ª≠a thu·ªëc -->
    <div id="editMedicineModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Ch·ªânh s·ª≠a thu·ªëc</h2>
          <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editMedicineForm">
            <div class="form-row">
              <div class="form-group">
                <label for="editMedicineImage">·∫¢nh:</label>
                <input type="file" id="editMedicineImage" accept="image/*" />
              </div>
              <div class="form-group">
                <label for="editMedicineCode">M√£ thu·ªëc:</label>
                <input type="text" id="editMedicineCode" placeholder="Nh·∫≠p m√£ thu·ªëc" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editMedicineName">T√™n thu·ªëc:</label>
                <input type="text" id="editMedicineName" placeholder="Nh·∫≠p t√™n thu·ªëc" />
              </div>
              <div class="form-group">
                <label for="editMedicineUnit">ƒê∆°n v·ªã:</label>
                <input type="text" id="editMedicineUnit" placeholder="Nh·∫≠p ƒë∆°n v·ªã" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editImportPrice">Gi√° nh·∫≠p:</label>
                <input type="number" id="editImportPrice" placeholder="Nh·∫≠p gi√° nh·∫≠p" />
              </div>
              <div class="form-group">
                <label for="editSalePrice">Gi√° b√°n:</label>
                <input type="number" id="editSalePrice" placeholder="Nh·∫≠p gi√° b√°n" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editAddDate">Ng√†y th√™m:</label>
                <input type="date" id="editAddDate" />
              </div>
              <div class="form-group">
                <label for="editQuantity">S·ªë l∆∞·ª£ng:</label>
                <input type="number" id="editQuantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng" min="0" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editMinQuantity">S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu:</label>
                <input type="number" id="editMinQuantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng t·ªëi thi·ªÉu" min="0" />
              </div>
              <div class="form-group">
                <label for="editExpiryDate">H·∫°n s·ª≠ d·ª•ng:</label>
                <input type="date" id="editExpiryDate" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editMedicineGroup">Nh√≥m thu·ªëc:</label>
                <select id="editMedicineGroup">
                  <option value="Thu·ªëc kh√¥ng k√™ ƒë∆°n">Thu·ªëc kh√¥ng k√™ ƒë∆°n</option>
                  <option value="Thu·ªëc k√™ ƒë∆°n">Thu·ªëc k√™ ƒë∆°n</option>
                  <option value="Th·ª±c ph·∫©m ch·ª©c nƒÉng">Th·ª±c ph·∫©m ch·ª©c nƒÉng</option>
                  <option value="D·ª•ng c·ª• y t·∫ø">D·ª•ng c·ª• y t·∫ø</option>
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-primary" onclick="updateMedicine()">L∆∞u</button>
              <button type="button" class="btn btn-secondary" onclick="closeEditModal()">H·ªßy</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </body>
    <script src="../assets/js/sidebar.js"></script>
    <script src="../config/supabase.js"></script>
    <script src="../config/api.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('warehouseSearchInput');
      const tableBody = document.getElementById('warehouseTableBody');
      
      // Bi·∫øn qu·∫£n l√Ω ph√¢n trang v√† s·∫Øp x·∫øp
      let allMedicines = [];
      let currentPage = 1;
      const itemsPerPage = 10; // Hi·ªÉn th·ªã 10 d√≤ng m·ªói trang
      let sortColumn = -1;
      let sortDirection = 'asc';
      let selectedMedicine = null; // L∆∞u thu·ªëc ƒë∆∞·ª£c ch·ªçn cho context menu

      // Load d·ªØ li·ªáu thu·ªëc t·ª´ API khi trang load
      loadMedicineData();

      searchInput.addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          if (text.includes(keyword)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });

      // X·ª≠ l√Ω modal th√™m thu·ªëc
      document.querySelector('.add-button').addEventListener('click', function() {
        document.getElementById('addMedicineModal').style.display = 'block';
      });

      async function loadMedicineData() {
        try {
          // Hi·ªÉn th·ªã loading
          tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
          
          UI.showLoading();
          
          // L·∫•y d·ªØ li·ªáu t·ª´ Supabase
          const response = await API.getThuoc();
          allMedicines = response.records || [];
          
          displayMedicineData();
          updatePagination();
        } catch (error) {
          console.error('L·ªói:', error);
          UI.showMessage('L·ªói khi t·∫£i d·ªØ li·ªáu thu·ªëc: ' + error.message, 'error');
          tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px; color: red;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
        } finally {
          UI.hideLoading();
        }
      }

      function displayMedicineData() {
        tableBody.innerHTML = '';
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, allMedicines.length);
        const medicinesToShow = allMedicines.slice(startIndex, endIndex);
        medicinesToShow.forEach((medicine, index) => {
          const row = document.createElement('tr');
          
          // X·ª≠ l√Ω ·∫£nh t·ª´ database
          let imageSrc = '../assets/images/placeholder.png'; // ·∫£nh m·∫∑c ƒë·ªãnh
          if (medicine.anh && medicine.anh !== 'placeholder.png') {
            imageSrc = `../assets/images/${medicine.anh}`;
          }
          
          // X·ª≠ l√Ω h·∫°n s·ª≠ d·ª•ng
          const hanSuDung = medicine.han_su_dung || 'N/A';
          
          row.innerHTML = `
            <td><img src="${imageSrc}" alt="${medicine.ten_thuoc}" onerror="this.src='../assets/images/placeholder.png'" style="width: 50px; height: 50px; object-fit: cover;" /></td>
            <td>#${medicine.ma_thuoc.toString().padStart(3, '0')}</td>
            <td>${medicine.ten_thuoc}</td>
            <td>${medicine.don_vi}</td>
            <td>${parseInt(medicine.gia_nhap).toLocaleString()} VND</td>
            <td>${parseInt(medicine.gia_ban).toLocaleString()} VND</td>
            <td>${medicine.ngay_them}</td>
            <td class="${parseInt(medicine.so_luong || 0) < parseInt(medicine.sl_toi_thieu || 0) ? 'low-stock' : ''}">${medicine.so_luong || 0}</td>
            <td>${medicine.nhom_thuoc || 'N/A'}</td>
            <td>${hanSuDung}</td>
            <td class="${medicine.trang_thai === 'H·∫øt h·∫°n' ? 'expired' : (medicine.trang_thai === 'C√≤n h·∫°n' ? 'active' : 'unknown')}">${medicine.trang_thai || 'N/A'}</td>
          `;
          
          // Th√™m context menu cho chu·ªôt ph·∫£i
          row.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            showContextMenu(e, medicine);
          });
          tableBody.appendChild(row);
        });
        // N·∫øu kh√¥ng c√≥ thu·ªëc n√†o tr√™n trang n√†y
        if (medicinesToShow.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu thu·ªëc</td></tr>';
        }
      }

      function updatePagination() {
        const totalPages = Math.ceil(allMedicines.length / itemsPerPage) || 1;
        const pagination = document.getElementById('warehousePagination');
        pagination.innerHTML = '';
        // N√∫t Previous
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '<';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            displayMedicineData();
            updatePagination();
          }
        };
        pagination.appendChild(prevBtn);
        // C√°c n√∫t s·ªë trang
        for (let i = 1; i <= totalPages; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.textContent = i;
          pageBtn.className = i === currentPage ? 'active' : '';
          pageBtn.onclick = () => {
            currentPage = i;
            displayMedicineData();
            updatePagination();
          };
          pagination.appendChild(pageBtn);
        }
        // N√∫t Next
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            displayMedicineData();
            updatePagination();
          }
        };
        pagination.appendChild(nextBtn);
      }

      function closeModal() {
        document.getElementById('addMedicineModal').style.display = 'none';
        document.getElementById('addMedicineForm').reset();
      }

      async function saveMedicine() {
        const medicineName = document.getElementById('medicineName').value;
        const medicineUnit = document.getElementById('medicineUnit').value;
        const importPrice = document.getElementById('importPrice').value;
        const salePrice = document.getElementById('salePrice').value;
        const quantity = document.getElementById('quantity').value;
        const minQuantity = document.getElementById('minQuantity').value;
        const medicineGroup = document.getElementById('medicineGroup').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const addDate = document.getElementById('addDate').value;
        const trangThai = 'C√≤n h·∫°n';

        if (!medicineName || !medicineUnit || !importPrice || !salePrice) {
          UI.showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
          return;
        }

        try {
          UI.showLoading();
          
          const thuocData = {
            ten_thuoc: medicineName,
            don_vi: medicineUnit,
            gia_nhap: parseFloat(importPrice),
            gia_ban: parseFloat(salePrice),
            so_luong: parseInt(quantity) || 0,
            sl_toi_thieu: parseInt(minQuantity) || 10,
            nhom_thuoc: medicineGroup,
            han_su_dung: expiryDate || null,
            ngay_them: addDate || new Date().toISOString().split('T')[0],
            trang_thai: trangThai,
            anh: 'placeholder.png'
          };

          await API.createThuoc(thuocData);
          UI.showMessage('Thu·ªëc ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!', 'success');
          closeModal();
          await loadMedicineData();
        } catch (error) {
          console.error('L·ªói:', error);
          UI.showMessage('L·ªói khi th√™m thu·ªëc: ' + error.message, 'error');
        } finally {
          UI.hideLoading();
        }
      }

      // ƒê√≥ng modal khi click b√™n ngo√†i v·ªõi x√°c nh·∫≠n
      window.onclick = function(event) {
        const modal = document.getElementById('addMedicineModal');
        const editModal = document.getElementById('editMedicineModal');
        
        if (event.target == modal) {
          // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu ƒë√£ nh·∫≠p ch∆∞a
          if (hasFormData()) {
            if (confirm('B·∫°n ch∆∞a ho√†n t·∫•t th√™m thu·ªëc m·ªõi. B·∫°n c√≥ mu·ªën r·ªùi m√† kh√¥ng ho√†n t·∫•t kh√¥ng?')) {
              closeModal();
            }
          } else {
            closeModal();
          }
        }
        
        if (event.target == editModal) {
          // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu ƒë√£ nh·∫≠p ch∆∞a trong form edit
          if (hasEditFormData()) {
            if (confirm('B·∫°n ch∆∞a ho√†n t·∫•t thao t√°c. B·∫°n c√≥ mu·ªën r·ªùi m√† kh√¥ng ho√†n t·∫•t kh√¥ng?')) {
              closeEditModal();
            }
          } else {
            closeEditModal();
          }
        }
      }

      // Function ki·ªÉm tra xem form c√≥ d·ªØ li·ªáu ch∆∞a
      function hasFormData() {
        const medicineName = document.getElementById('medicineName').value.trim();
        const medicineUnit = document.getElementById('medicineUnit').value.trim();
        const medicineCode = document.getElementById('medicineCode').value.trim();
        const importPrice = document.getElementById('importPrice').value.trim();
        const salePrice = document.getElementById('salePrice').value.trim();
        const quantity = document.getElementById('quantity').value.trim();
        const minQuantity = document.getElementById('minQuantity').value.trim();
        const medicineGroup = document.getElementById('medicineGroup').value.trim();
        const expiryDate = document.getElementById('expiryDate').value.trim();
        const addDate = document.getElementById('addDate').value.trim();
        const imageFile = document.getElementById('medicineImage').files.length > 0;
        
        return medicineName || medicineCode || medicineUnit || importPrice || salePrice || 
               quantity || minQuantity || medicineGroup || expiryDate || addDate || imageFile;
      }

      // Function s·∫Øp x·∫øp b·∫£ng
      function sortTable(columnIndex) {
        if (sortColumn === columnIndex) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = columnIndex;
          sortDirection = 'asc';
        }

        allMedicines.sort((a, b) => {
          let valueA, valueB;
          
          switch(columnIndex) {
            case 0: // M√£ thu·ªëc
              valueA = parseInt(a.ma_thuoc);
              valueB = parseInt(b.ma_thuoc);
              break;
            case 1: // T√™n thu·ªëc
              valueA = a.ten_thuoc.toLowerCase();
              valueB = b.ten_thuoc.toLowerCase();
              break;
            case 2: // ƒê∆°n v·ªã
              valueA = a.don_vi.toLowerCase();
              valueB = b.don_vi.toLowerCase();
              break;
            case 3: // Gi√° nh·∫≠p
              valueA = parseInt(a.gia_nhap);
              valueB = parseInt(b.gia_nhap);
              break;
            case 4: // Gi√° b√°n
              valueA = parseInt(a.gia_ban);
              valueB = parseInt(b.gia_ban);
              break;
            case 5: // Ng√†y th√™m
              valueA = new Date(a.ngay_them);
              valueB = new Date(b.ngay_them);
              break;
            case 6: // S·ªë l∆∞·ª£ng
              valueA = parseInt(a.so_luong || 0);
              valueB = parseInt(b.so_luong || 0);
              break;
            case 7: // Nh√≥m thu·ªëc
              valueA = String(a.nhom_thuoc || '').toLowerCase();
              valueB = String(b.nhom_thuoc || '').toLowerCase();
              break;
            case 8: // H·∫°n s·ª≠ d·ª•ng
              valueA = a.han_su_dung ? new Date(a.han_su_dung) : new Date('1900-01-01');
              valueB = b.han_su_dung ? new Date(b.han_su_dung) : new Date('1900-01-01');
              break;
            case 9: // Tr·∫°ng th√°i
              valueA = String(a.trang_thai || '').toLowerCase();
              valueB = String(b.trang_thai || '').toLowerCase();
              break;
            default:
              return 0;
          }

          if (valueA < valueB) {
            return sortDirection === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return sortDirection === 'asc' ? 1 : -1;
          }
          return 0;
        });

        currentPage = 1; // Reset v·ªÅ trang ƒë·∫ßu sau khi s·∫Øp x·∫øp
        displayMedicineData();
        updatePagination();
      }

      // Function ki·ªÉm tra xem form edit c√≥ d·ªØ li·ªáu ch∆∞a
      function hasEditFormData() {
        const editMedicineName = document.getElementById('editMedicineName').value.trim();
        const editMedicineUnit = document.getElementById('editMedicineUnit').value.trim();
        const editImportPrice = document.getElementById('editImportPrice').value.trim();
        const editSalePrice = document.getElementById('editSalePrice').value.trim();
        const editQuantity = document.getElementById('editQuantity').value.trim();
        const editMinQuantity = document.getElementById('editMinQuantity').value.trim();
        const editMedicineGroup = document.getElementById('editMedicineGroup').value.trim();
        const editExpiryDate = document.getElementById('editExpiryDate').value.trim();
        const editAddDate = document.getElementById('editAddDate').value.trim();
        const editImageFile = document.getElementById('editMedicineImage').files.length > 0;
        
        return editMedicineName || editMedicineUnit || editImportPrice || editSalePrice || 
               editQuantity || editMinQuantity || editMedicineGroup || editExpiryDate || editAddDate || editImageFile;
      }

      // Function hi·ªÉn th·ªã context menu
      function showContextMenu(e, medicine) {
        selectedMedicine = medicine;
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'block';
        
        // T√≠nh to√°n v·ªã tr√≠ ƒë·ªÉ context menu hi·ªÉn th·ªã ·ªü g√≥c ph·∫£i d∆∞·ªõi tr·ªè chu·ªôt
        const menuWidth = 150; // Chi·ªÅu r·ªông context menu
        const menuHeight = 80; // Chi·ªÅu cao context menu
        
        // L·∫•y k√≠ch th∆∞·ªõc viewport
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // T√≠nh to√°n v·ªã tr√≠ X
        let left = e.pageX;
        if (left + menuWidth > viewportWidth) {
          left = e.pageX - menuWidth;
        }
        
        // T√≠nh to√°n v·ªã tr√≠ Y
        let top = e.pageY;
        if (top + menuHeight > viewportHeight) {
          top = e.pageY - menuHeight;
        }
        
        contextMenu.style.left = left + 'px';
        contextMenu.style.top = top + 'px';
        
        // ·∫®n context menu khi click ra ngo√†i
        setTimeout(() => {
          document.addEventListener('click', hideContextMenu);
        }, 0);
      }

      function hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
        document.removeEventListener('click', hideContextMenu);
      }

      function editSelectedMedicine() {
        if (selectedMedicine) {
          // ƒêi·ªÅn d·ªØ li·ªáu tr·ª±c ti·∫øp v√†o form ch·ªânh s·ª≠a
          document.getElementById('editMedicineCode').value = `#${selectedMedicine.ma_thuoc.toString().padStart(3, '0')}`;
          document.getElementById('editMedicineName').value = selectedMedicine.ten_thuoc;
          document.getElementById('editMedicineUnit').value = selectedMedicine.don_vi;
          document.getElementById('editImportPrice').value = selectedMedicine.gia_nhap;
          document.getElementById('editSalePrice').value = selectedMedicine.gia_ban;
          document.getElementById('editQuantity').value = selectedMedicine.so_luong || 0;
          document.getElementById('editAddDate').value = selectedMedicine.ngay_them;
          document.getElementById('editMinQuantity').value = selectedMedicine.sl_toi_thieu;
          document.getElementById('editExpiryDate').value = selectedMedicine.han_su_dung || '';
          document.getElementById('editMedicineGroup').value = selectedMedicine.nhom_thuoc || 'Thu·ªëc kh√¥ng k√™ ƒë∆°n';
          
          // L∆∞u reference ƒë·∫øn d√≤ng ƒëang ch·ªânh s·ª≠a (t·∫°o m·ªôt object gi·∫£)
          window.editingRow = {
            cells: [
              null, // ·∫¢nh
              { textContent: `#${selectedMedicine.ma_thuoc.toString().padStart(3, '0')}` },
              { textContent: selectedMedicine.ten_thuoc },
              { textContent: selectedMedicine.don_vi },
              { textContent: `${parseInt(selectedMedicine.gia_nhap).toLocaleString()} VND` },
              { textContent: `${parseInt(selectedMedicine.gia_ban).toLocaleString()} VND` },
              { textContent: selectedMedicine.ngay_them },
              { textContent: selectedMedicine.so_luong || 0 },
              { textContent: selectedMedicine.nhom_thuoc || 'N/A' },
              { textContent: selectedMedicine.han_su_dung || 'N/A' }
            ]
          };
          
          // Hi·ªán modal ch·ªânh s·ª≠a
          document.getElementById('editMedicineModal').style.display = 'block';
        }
        hideContextMenu();
      }

      async function deleteSelectedMedicine() {
        if (selectedMedicine) {
          if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thu·ªëc n√†y?')) {
            try {
              UI.showLoading();
              await API.deleteThuoc(selectedMedicine.ma_thuoc);
              UI.showMessage('Thu·ªëc ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!', 'success');
              await loadMedicineData();
            } catch (error) {
              console.error('L·ªói:', error);
              UI.showMessage('L·ªói khi x√≥a thu·ªëc: ' + error.message, 'error');
            } finally {
              UI.hideLoading();
            }
          }
        }
        hideContextMenu();
      }

      // ƒê∆∞a c√°c function ra global scope ƒë·ªÉ onclick c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c
      window.closeModal = closeModal;
      window.saveMedicine = saveMedicine;
      window.editMedicine = editMedicine;
      window.closeEditModal = closeEditModal;
      window.updateMedicine = updateMedicine;
      window.deleteMedicine = deleteMedicine;
      window.sortTable = sortTable;
      window.showContextMenu = showContextMenu;
      window.hideContextMenu = hideContextMenu;
      window.editSelectedMedicine = editSelectedMedicine;
      window.deleteSelectedMedicine = deleteSelectedMedicine;

      // Function ch·ªânh s·ª≠a thu·ªëc
      function editMedicine(button) {
        const row = button.closest('tr');
        const cells = row.cells;
        
        // L·∫•y d·ªØ li·ªáu t·ª´ d√≤ng hi·ªán t·∫°i
        const medicineCode = cells[1].textContent;
        const medicineName = cells[2].textContent;
        const medicineUnit = cells[3].textContent;
        const importPrice = cells[4].textContent.replace(' VND', '').replace(/,/g, '');
        const salePrice = cells[5].textContent.replace(' VND', '').replace(/,/g, '');
        const addDate = cells[6].textContent === 'N/A' ? '' : cells[6].textContent;
        const quantity = cells[7].textContent === 'N/A' ? '' : cells[7].textContent;
        const medicineGroup = cells[8].textContent === 'N/A' ? '' : cells[8].textContent;
        const expiryDate = cells[9].textContent === 'N/A' ? '' : cells[9].textContent;

        // ƒêi·ªÅn d·ªØ li·ªáu v√†o form ch·ªânh s·ª≠a
        document.getElementById('editMedicineCode').value = medicineCode;
        document.getElementById('editMedicineName').value = medicineName;
        document.getElementById('editMedicineUnit').value = medicineUnit;
        document.getElementById('editImportPrice').value = importPrice;
        document.getElementById('editSalePrice').value = salePrice;
        document.getElementById('editQuantity').value = quantity;
        document.getElementById('editAddDate').value = addDate;
        document.getElementById('editMinQuantity').value = ''; // Gi·ªØ tr·ªëng v√¨ kh√¥ng c√≤n hi·ªÉn th·ªã trong b·∫£ng
        document.getElementById('editExpiryDate').value = expiryDate;
        document.getElementById('editMedicineGroup').value = medicineGroup;

        // L∆∞u reference ƒë·∫øn d√≤ng ƒëang ch·ªânh s·ª≠a
        window.editingRow = row;

        // Hi·ªán modal ch·ªânh s·ª≠a
        document.getElementById('editMedicineModal').style.display = 'block';
      }

      function closeEditModal() {
        document.getElementById('editMedicineModal').style.display = 'none';
        document.getElementById('editMedicineForm').reset();
        window.editingRow = null;
      }

      async function updateMedicine() {
        if (!selectedMedicine) return;
        
        const medicineName = document.getElementById('editMedicineName').value;
        const medicineUnit = document.getElementById('editMedicineUnit').value;
        const importPrice = document.getElementById('editImportPrice').value;
        const salePrice = document.getElementById('editSalePrice').value;
        const quantity = document.getElementById('editQuantity').value;
        const addDate = document.getElementById('editAddDate').value;
        const minQuantity = document.getElementById('editMinQuantity').value;
        const expiryDate = document.getElementById('editExpiryDate').value;
        const medicineGroup = document.getElementById('editMedicineGroup').value;
        
        if (!medicineName || !medicineUnit || !importPrice || !salePrice) {
          UI.showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
          return;
        }
        
        try {
          UI.showLoading();
          
          const thuocData = {
            ten_thuoc: medicineName,
            don_vi: medicineUnit,
            gia_nhap: parseFloat(importPrice),
            gia_ban: parseFloat(salePrice),
            so_luong: parseInt(quantity) || 0,
            ngay_them: addDate,
            sl_toi_thieu: parseInt(minQuantity) || 10,
            han_su_dung: expiryDate || null,
            nhom_thuoc: medicineGroup
          };
          
          await API.updateThuoc(selectedMedicine.ma_thuoc, thuocData);
          UI.showMessage('Thu·ªëc ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
          closeEditModal();
          await loadMedicineData();
        } catch (error) {
          console.error('L·ªói:', error);
          UI.showMessage('L·ªói khi c·∫≠p nh·∫≠t thu·ªëc: ' + error.message, 'error');
        } finally {
          UI.hideLoading();
        }
      }

      function deleteMedicine(button) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thu·ªëc n√†y?')) {
          const row = button.closest('tr');
          const maThuoc = row.cells[1].textContent.replace('#', '').trim();
          // Simulate API call for frontend-only version
          setTimeout(() => {
            alert('Thu·ªëc ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng (Demo mode)');
            loadMedicineData();
          }, 500);
        }
      }
    });
  </script>
</html>
