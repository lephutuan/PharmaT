<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản Lý Tiệm Thuốc Tự Động - Đơn Thuốc</title>
    <link rel="stylesheet" href="../assets/css/prescriptions.css" />
    <link rel="stylesheet" href="../assets/css/api-styles.css" />
    <link rel="stylesheet" href="../assets/css/common-responsive.css" />
    <!-- Awesomplete CSS & JS CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <img
          src="../assets/images/logo.png"
          alt="PharmaT Logo"
          class="logo-img"
          onclick="window.location.href='../../../index.html'"
        />
      </div>
      <div class="page-title">
        <h1>Đơn thuốc</h1>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="../../../index.html" onclick="setActive(this)"
            >🏠 Trang chủ</a
          >
        </li>
        <li>
          <a href="warehouse.html" onclick="setActive(this)">📦 Kho thuốc</a>
        </li>
        <li>
          <a href="prescriptions.html" onclick="setActive(this)"
            >📝 Đơn thuốc</a
          >
        </li>
        <li>
          <a href="employees.html" onclick="setActive(this)">👥 Nhân viên</a>
        </li>
        <li>
          <a href="members.html" onclick="setActive(this)">💎 Hội viên</a>
        </li>
        <li>
          <a href="checkout.html" onclick="setActive(this)">💳 Thanh toán</a>
        </li>
        <li>
          <a href="reports.html" onclick="setActive(this)"
            >📈 Báo cáo & Thống kê</a
          >
        </li>
        <li>
          <a href="chatbox.html" onclick="setActive(this)"
            >🤖 Chatbox cảnh báo</a
          >
        </li>
      </ul>

      <!-- Logout Button -->
      <div class="sidebar-footer">
        <a href="login.html" class="logout-btn" onclick="logout()">
          <i class="fa-solid fa-sign-out-alt"></i>
          Đăng xuất
        </a>
      </div>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <main>
      <!-- 1. Thông tin khách hàng và nhân viên -->
      <section class="form-section">
        <h2>Thông tin khách hàng và nhân viên</h2>
        <div class="customer-form">
          <!-- Loại khách hàng -->
          <div style="margin-bottom: 15px">
            <label style="display: block; margin-bottom: 5px; font-weight: bold"
              >Loại khách hàng:</label
            >
            <div style="display: flex; gap: 20px">
              <label style="cursor: pointer">
                <input
                  type="radio"
                  name="customerType"
                  value="vanglai"
                  checked
                  onchange="toggleCustomerType()"
                />
                Khách vãng lai
              </label>
              <label style="cursor: pointer">
                <input
                  type="radio"
                  name="customerType"
                  value="hoivien"
                  onchange="toggleCustomerType()"
                />
                Hội viên
              </label>
            </div>
          </div>

          <!-- Form khách vãng lai -->
          <div id="vanglaiForm" style="margin-bottom: 15px">
            <input
              type="text"
              id="vanglaiName"
              placeholder="Tên khách hàng (tùy chọn)"
              style="width: 250px; margin-right: 10px"
            />
            <input
              type="text"
              id="vanglaiAllergy"
              placeholder="Dị ứng (nếu có)"
              style="width: 250px"
            />
            <p style="color: #666; font-size: 0.9em; margin-top: 5px">
              <i class="fa fa-info-circle"></i> Thông tin chỉ lưu cho đơn này,
              không lưu vào hệ thống
            </p>
          </div>

          <!-- Form hội viên -->
          <div id="hoivienForm" style="display: none; margin-bottom: 15px">
            <div style="margin-bottom: 15px">
              <label
                for="customerSelect"
                style="display: block; margin-bottom: 5px; font-weight: bold"
                >Chọn hội viên:</label
              >
              <select id="customerSelect">
                <option value="">-- Chọn hội viên --</option>
                <!-- Các option sẽ được render từ JS -->
              </select>
              <button class="btn btn-secondary" id="btnAddCustomer">
                + Đăng ký hội viên mới
              </button>
            </div>

            <div
              id="addCustomerForm"
              style="
                display: none;
                gap: 8px;
                align-items: center;
                margin-top: 8px;
              "
            >
              <input
                type="text"
                id="newCustomerName"
                placeholder="Tên khách hàng"
                style="width: 180px"
              />
              <input
                type="text"
                id="newCustomerPhone"
                placeholder="SĐT"
                style="width: 120px"
              />
              <input
                type="text"
                id="newCustomerAllergy"
                placeholder="Dị ứng (nếu có)"
                style="width: 180px"
              />
              <button class="btn btn-primary" id="btnSaveCustomer">
                <i class="fa fa-save"></i> Lưu
              </button>
              <button class="btn btn-danger" id="btnCancelAddCustomer">
                <i class="fa fa-times"></i> Hủy
              </button>
            </div>

            <div class="customer-info" id="customerInfo">
              <!-- Tên, sđt, dị ứng, cấp thành viên sẽ hiển thị tại đây -->
            </div>
          </div>
          <div style="margin-bottom: 15px">
            <label
              for="employeeSelect"
              style="display: block; margin-bottom: 5px; font-weight: bold"
              >Nhân viên thực hiện:</label
            >
            <select id="employeeSelect">
              <option value="">-- Chọn nhân viên --</option>
              <!-- Các option sẽ được render từ JS -->
            </select>
          </div>

          <!-- Form thêm khách hàng mới, ẩn mặc định -->
        </div>
      </section>

      <!-- 2. Thêm thuốc vào đơn -->
      <section class="form-section">
        <h2>Thêm thuốc vào đơn</h2>
        <div class="medicine-form">
          <input
            id="medicineSearch"
            class="awesomplete"
            type="text"
            placeholder="Tìm thuốc..."
            autocomplete="off"
          />
          <input type="text" placeholder="Liều lượng" id="dose" />
          <input type="number" placeholder="Số ngày" id="days" />
          <input type="number" placeholder="Số lượng" id="quantity" />
          <button class="btn btn-primary" onclick="addMedicine()">
            + Thêm thuốc
          </button>
        </div>
      </section>

      <!-- 3. Danh sách thuốc trong đơn -->
      <section class="form-section">
        <h2>Danh sách thuốc</h2>
        <table class="medicine-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>Tên thuốc</th>
              <th>Liều dùng</th>
              <th>Số ngày</th>
              <th>Số lượng</th>
              <th>Xóa</th>
            </tr>
          </thead>
          <tbody id="medicineList">
            <!-- JS render thuốc tại đây -->
          </tbody>
        </table>
      </section>

      <!-- 4. Hành động -->
      <section class="form-section">
        <button class="btn btn-success" onclick="submitPrescription()">
          💾 Lưu đơn thuốc
        </button>
        <button class="btn btn-danger" onclick="cancelPrescription()">
          ❌ Hủy
        </button>
      </section>
    </main>
  </body>
  <script src="../assets/js/sidebar.js"></script>
  <script src="../config/supabase.js"></script>
  <script src="../config/api.js"></script>
  <script>
    // Biến toàn cục
    let selectedMedicines = [];
    let selectedCustomer = null;
    let selectedEmployee = null;
    let allCustomers = [];
    let allEmployees = [];
    let allMedicines = [];
    let customerType = "vanglai"; // 'vanglai' hoặc 'hoivien'

    // Khởi tạo khi trang load
    document.addEventListener("DOMContentLoaded", async function () {
      try {
        UI.showLoading();
        await loadData();
        initializeAwesomplete();
        setupEventListeners();
      } catch (error) {
        console.error("Lỗi khi khởi tạo:", error);
        UI.showMessage("Lỗi khi tải dữ liệu: " + error.message, "error");
      } finally {
        UI.hideLoading();
      }
    });

    // Load dữ liệu từ database
    async function loadData() {
      try {
        // Load khách hàng
        const customersResponse = await API.getKhachHang();
        allCustomers = customersResponse.records || [];

        // Load nhân viên
        const employeesResponse = await API.getNhanVien();
        allEmployees = employeesResponse.records || [];

        // Load thuốc
        const medicinesResponse = await API.getThuoc();
        allMedicines = medicinesResponse.records || [];

        // Populate selects
        populateSelects();
      } catch (error) {
        console.error("Lỗi khi load dữ liệu:", error);
        throw error;
      }
    }

    // Khởi tạo Awesomplete
    function initializeAwesomplete() {
      const input = document.getElementById("medicineSearch");

      // Tạo danh sách tên thuốc từ database
      const medicineNames = allMedicines.map((m) => m.ten_thuoc);

      const awesomplete = new Awesomplete(input, {
        minChars: 1,
        maxItems: 10,
        autoFirst: true,
        list: medicineNames,
        filter: function (text, input) {
          return Awesomplete.FILTER_CONTAINS(text, input);
        },
      });

      input.addEventListener("awesomplete-selectcomplete", function (evt) {
        const selectedName = input.value.trim();
        const medicine = allMedicines.find((m) => m.ten_thuoc === selectedName);

        if (medicine) {
          input.dataset.selectedId = medicine.ma_thuoc;
          input.dataset.selectedPrice = medicine.gia_ban;
        } else {
          delete input.dataset.selectedId;
          delete input.dataset.selectedPrice;
        }
      });
    }

    // Toggle loại khách hàng
    function toggleCustomerType() {
      const type = document.querySelector(
        'input[name="customerType"]:checked'
      ).value;
      customerType = type;

      const vanglaiForm = document.getElementById("vanglaiForm");
      const hoivienForm = document.getElementById("hoivienForm");

      if (type === "vanglai") {
        vanglaiForm.style.display = "block";
        hoivienForm.style.display = "none";
        selectedCustomer = null;
      } else {
        vanglaiForm.style.display = "none";
        hoivienForm.style.display = "block";
      }
    }

    // Populate selects với dữ liệu từ database
    function populateSelects() {
      // Populate customer select (chỉ hội viên)
      const customerSelect = document.getElementById("customerSelect");
      customerSelect.innerHTML =
        '<option value="">-- Chọn hội viên --</option>';

      // Filter chỉ lấy hội viên
      const hoivienList = allCustomers.filter((c) => c.loai_kh === "Hội viên");

      hoivienList.forEach((customer) => {
        const option = document.createElement("option");
        option.value = customer.ma_kh;
        const cap = customer.cap_thanh_vien || "Bronze";
        const capIcon =
          cap === "VIP"
            ? "👑"
            : cap === "Gold"
            ? "🥇"
            : cap === "Silver"
            ? "🥈"
            : "🥉";
        option.textContent = `${capIcon} ${customer.ten_kh} - ${customer.sdt} [${cap}]`;
        customerSelect.appendChild(option);
      });

      // Populate employee select
      const employeeSelect = document.getElementById("employeeSelect");
      employeeSelect.innerHTML =
        '<option value="">-- Chọn nhân viên --</option>';
      allEmployees.forEach((employee) => {
        const option = document.createElement("option");
        option.value = employee.ma_nv;
        option.textContent = `${employee.ten_nv} - ${employee.chuc_vu}`;
        employeeSelect.appendChild(option);
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Customer select change
      document
        .getElementById("customerSelect")
        .addEventListener("change", function () {
          const customerId = this.value;
          if (customerId) {
            selectedCustomer = allCustomers.find((c) => c.ma_kh == customerId);
            displayCustomerInfo(selectedCustomer);
          } else {
            selectedCustomer = null;
            document.getElementById("customerInfo").innerHTML = "";
          }
        });

      // Employee select change
      document
        .getElementById("employeeSelect")
        .addEventListener("change", function () {
          const employeeId = this.value;
          if (employeeId) {
            selectedEmployee = allEmployees.find((e) => e.ma_nv == employeeId);
          } else {
            selectedEmployee = null;
          }
        });

      // Add customer button
      document
        .getElementById("btnAddCustomer")
        .addEventListener("click", function () {
          this.style.display = "none";
          document.getElementById("addCustomerForm").style.display = "flex";
        });

      // Cancel add customer
      document
        .getElementById("btnCancelAddCustomer")
        .addEventListener("click", function () {
          document.getElementById("addCustomerForm").style.display = "none";
          document.getElementById("btnAddCustomer").style.display =
            "inline-block";
          clearAddCustomerForm();
        });

      // Save customer
      document
        .getElementById("btnSaveCustomer")
        .addEventListener("click", async function () {
          const name = document.getElementById("newCustomerName").value.trim();
          const phone = document
            .getElementById("newCustomerPhone")
            .value.trim();
          const allergy = document
            .getElementById("newCustomerAllergy")
            .value.trim();

          if (!name || !phone) {
            UI.showMessage(
              "Vui lòng nhập tên và số điện thoại khách hàng!",
              "error"
            );
            return;
          }

          try {
            UI.showLoading();

            // Thêm khách hàng vào database
            const newCustomer = await API.createKhachHang({
              ten_kh: name,
              sdt: phone,
              di_ung: allergy || "Không có",
            });

            // Reload danh sách khách hàng
            const customersResponse = await API.getKhachHang();
            allCustomers = customersResponse.records || [];
            populateSelects();

            // Chọn khách hàng vừa tạo
            document.getElementById("customerSelect").value = newCustomer.ma_kh;
            selectedCustomer = newCustomer;
            displayCustomerInfo(selectedCustomer);

            document.getElementById("addCustomerForm").style.display = "none";
            document.getElementById("btnAddCustomer").style.display =
              "inline-block";
            clearAddCustomerForm();

            UI.showMessage("Đã thêm khách hàng mới thành công!", "success");
          } catch (error) {
            console.error("Lỗi:", error);
            UI.showMessage(
              "Lỗi khi thêm khách hàng: " + error.message,
              "error"
            );
          } finally {
            UI.hideLoading();
          }
        });
    }

    // Clear add customer form
    function clearAddCustomerForm() {
      document.getElementById("newCustomerName").value = "";
      document.getElementById("newCustomerPhone").value = "";
      document.getElementById("newCustomerAllergy").value = "";
    }

    // Display customer info
    function displayCustomerInfo(customer) {
      const infoDiv = document.getElementById("customerInfo");
      const cap = customer.cap_thanh_vien || "Bronze";
      const capIcon =
        cap === "VIP"
          ? "👑"
          : cap === "Gold"
          ? "🥇"
          : cap === "Silver"
          ? "🥈"
          : "🥉";
      const discount =
        cap === "VIP"
          ? "20%"
          : cap === "Gold"
          ? "15%"
          : cap === "Silver"
          ? "10%"
          : "0%";
      const tongTien = customer.tong_tien_da_mua || 0;

      infoDiv.innerHTML = `
        <div class="customer-details" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 10px;">
          <p><strong>Tên:</strong> ${customer.ten_kh}</p>
          <p><strong>SĐT:</strong> ${customer.sdt}</p>
          <p><strong>Dị ứng:</strong> ${customer.di_ung || "Không có"}</p>
          <p><strong>Cấp:</strong> ${capIcon} ${cap} <span style="color: #10b981; font-weight: bold;">(Giảm ${discount})</span></p>
          <p><strong>Tổng đã mua:</strong> ${formatCurrency(tongTien)}</p>
        </div>
      `;
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
      }).format(amount);
    }

    // Add medicine to prescription
    function addMedicine() {
      const searchInput = document.getElementById("medicineSearch");
      const doseInput = document.getElementById("dose");
      const daysInput = document.getElementById("days");
      const quantityInput = document.getElementById("quantity");

      const medicineId = searchInput.dataset.selectedId;
      const medicineName = searchInput.value;
      const dose = doseInput.value.trim();
      const days = parseInt(daysInput.value);
      const quantity = parseInt(quantityInput.value);

      if (!medicineId || !dose || !days || !quantity) {
        UI.showMessage("Vui lòng điền đầy đủ thông tin thuốc", "error");
        return;
      }

      // Kiểm tra xem thuốc đã có trong đơn chưa
      const existingMedicine = selectedMedicines.find(
        (m) => m.ma_thuoc == medicineId
      );
      if (existingMedicine) {
        UI.showMessage("Thuốc này đã có trong đơn!", "error");
        return;
      }

      const medicine = {
        ma_thuoc: parseInt(medicineId),
        ten_thuoc: medicineName,
        lieu_dung: dose,
        so_ngay: days,
        so_luong: quantity,
      };

      selectedMedicines.push(medicine);
      displayMedicineList();
      clearMedicineForm();
      UI.showMessage("Đã thêm thuốc vào đơn", "success");
    }

    // Display medicine list
    function displayMedicineList() {
      const tbody = document.getElementById("medicineList");
      tbody.innerHTML = "";

      selectedMedicines.forEach((medicine, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${medicine.ten_thuoc}</td>
          <td>${medicine.lieu_dung}</td>
          <td>${medicine.so_ngay}</td>
          <td>${medicine.so_luong}</td>
          <td><button onclick="removeMedicine(${index})" class="btn btn-danger btn-sm">Xóa</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // Remove medicine
    function removeMedicine(index) {
      const medicine = selectedMedicines[index];
      if (
        confirm(`Bạn có chắc chắn muốn xóa "${medicine.ten_thuoc}" khỏi đơn?`)
      ) {
        selectedMedicines.splice(index, 1);
        displayMedicineList();
        UI.showMessage("Đã xóa thuốc khỏi đơn", "success");
      }
    }

    // Clear medicine form
    function clearMedicineForm() {
      document.getElementById("medicineSearch").value = "";
      document.getElementById("dose").value = "";
      document.getElementById("days").value = "";
      document.getElementById("quantity").value = "";
      delete document.getElementById("medicineSearch").dataset.selectedId;
      delete document.getElementById("medicineSearch").dataset.selectedPrice;
    }

    // Submit prescription
    async function submitPrescription() {
      // Kiểm tra nhân viên
      if (!selectedEmployee) {
        UI.showMessage("Vui lòng chọn nhân viên thực hiện", "error");
        return;
      }

      // Kiểm tra thuốc
      if (selectedMedicines.length === 0) {
        UI.showMessage("Vui lòng thêm thuốc vào đơn", "error");
        return;
      }

      try {
        UI.showLoading();

        let donThuocData = {
          ma_nv: selectedEmployee.ma_nv,
          ngay_lap: new Date().toISOString().split("T")[0],
          trang_thai: "Đã lưu",
          ghi_chu: "",
        };

        // Xử lý theo loại khách hàng
        if (customerType === "hoivien") {
          // Hội viên: Phải chọn khách hàng
          if (!selectedCustomer) {
            UI.showMessage("Vui lòng chọn hội viên", "error");
            return;
          }
          donThuocData.ma_kh = selectedCustomer.ma_kh;
          donThuocData.di_ung_khach = null; // Không cần, lấy từ bảng khach_hang
        } else {
          // Khách vãng lai: Không lưu ma_kh, lưu dị ứng vào đơn
          const vanglaiAllergy = document
            .getElementById("vanglaiAllergy")
            .value.trim();
          donThuocData.ma_kh = null;
          donThuocData.di_ung_khach = vanglaiAllergy || null;
        }

        // Lưu đơn thuốc vào database
        await API.createDonThuoc(donThuocData, selectedMedicines);

        UI.showMessage("Đơn thuốc đã được lưu thành công!", "success");

        // Reset form sau 1 giây
        setTimeout(() => {
          resetForm();
        }, 1000);
      } catch (error) {
        console.error("Lỗi:", error);
        UI.showMessage("Lỗi khi lưu đơn thuốc: " + error.message, "error");
      } finally {
        UI.hideLoading();
      }
    }

    // Cancel prescription
    function cancelPrescription() {
      if (
        selectedMedicines.length > 0 ||
        selectedCustomer ||
        selectedEmployee
      ) {
        if (confirm("Bạn có chắc chắn muốn hủy đơn thuốc này?")) {
          resetForm();
          UI.showMessage("Đã hủy đơn thuốc", "success");
        }
      } else {
        UI.showMessage("Chưa có dữ liệu để hủy", "error");
      }
    }

    // Reset form
    function resetForm() {
      // Reset loại khách hàng về vãng lai
      document.querySelector(
        'input[name="customerType"][value="vanglai"]'
      ).checked = true;
      toggleCustomerType();

      // Reset form vãng lai
      document.getElementById("vanglaiName").value = "";
      document.getElementById("vanglaiAllergy").value = "";

      // Reset form hội viên
      document.getElementById("customerSelect").value = "";
      document.getElementById("customerInfo").innerHTML = "";
      document.getElementById("addCustomerForm").style.display = "none";
      document.getElementById("btnAddCustomer").style.display = "inline-block";

      // Reset chung
      document.getElementById("employeeSelect").value = "";
      document.getElementById("medicineList").innerHTML = "";
      selectedMedicines = [];
      selectedCustomer = null;
      selectedEmployee = null;
      clearMedicineForm();
    }
  </script>
</html>
